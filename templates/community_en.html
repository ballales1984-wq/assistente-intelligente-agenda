<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ù Community - Smart Assistant</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZCZ9CM8HDG">

        // ========================================
        // üîÑ AUTO-SYNCED FUNCTIONS (sync_multilang.py)
        // Date: 2025-11-04 15:45:00
        // ========================================

        // Function: formatReactionsCount
        function formatReactionsCount(count) {
                    if (count >= 10) return 'Molti';
                    if (count >= 5) return 'Alcuni';
                    return 'Poche persone';
                }

        // Function: updateCharCounter
        function updateCharCounter() {
                    const text = document.getElementById('reflectionText').value;
                    const counter = document.getElementById('charCounter');
                    const length = text.length;
                    
                    counter.textContent = `${length} / 5000 caratteri`;
                    
                    if (length < 20) {
                        counter.className = 'char-counter error';
                    } else if (length > 4500) {
                        counter.className = 'char-counter warning';
                    } else {
                        counter.className = 'char-counter';
                    }
                }

</script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-ZCZ9CM8HDG');
    </script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 800px; margin: 0 auto; }
        .header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header h1 { color: #667eea; margin-bottom: 10px; }
        .header p { color: #666; }
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .card h2 { color: #333; margin-bottom: 15px; }
        textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 10px;
        }
        textarea:focus { outline: none; border-color: #667eea; }
        select, button {
            padding: 12px 20px;
            border-radius: 10px;
            border: 2px solid #eee;
            font-family: inherit;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        button:hover { background: #5568d3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ù Community</h1>
            <p>Share your thoughts, receive genuine support</p>
            <p style="margin-top: 10px; font-size: 0.9em;">
                <a href="/en" style="color: #667eea;">‚Üê Back to Assistant</a> ‚Ä¢ 
                <a href="https://github.com/ballales1984-wq/assistente-intelligente-agenda/blob/main/COMMUNITY_GUIDELINES.md" target="_blank" style="color: #667eea;">üìñ Community Rules</a>
            </p>
        </div>

        <!-- Age & Crisis Disclaimer -->
        <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
            <h3 style="margin-top: 0; color: #d97706;">‚ö†Ô∏è Read Before Participating</h3>
            
            <div style="background: #fef9f3; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                <strong>üîû Adults Only (18+)</strong><br>
                You must be at least 18 years old to use the community.
            </div>
            
            <div style="background: #fff; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                <strong>üÜò If You're in Crisis:</strong><br>
                üìû <strong>988 Suicide & Crisis Lifeline</strong> (US, 24/7)<br>
                üìû <strong>Samaritans UK: 116 123</strong> (24/7)<br>
                üìû <strong>Crisis Text Line: Text HOME to 741741</strong>
            </div>
            
            <p style="font-size: 0.9em; margin-bottom: 0;">
                <strong>This is peer support, NOT professional therapy.</strong><br>
                ‚úÖ Share experiences ‚Ä¢ ‚ùå No unqualified medical advice<br>
                ‚ùå Violence, hate speech, spam = permanent ban<br>
                ‚ù§Ô∏è Be kind. Everyone is fighting a battle.
            </p>
        </div>

        <div class="card">
            <h2>‚ú® Share a Reflection</h2>
            <textarea id="reflectionText" placeholder="What did you learn today? What worries you? What makes you happy?

Share your genuine thoughts. The community will listen." maxlength="5000"></textarea>
            
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <select id="visibility" style="flex: 1;">
                    <option value="anonymous">üé≠ Anonymous</option>
                    <option value="public">üë§ Public (with your name)</option>
                </select>
                <select id="category" style="flex: 1;">
                    <option value="personal_growth">üå± Personal Growth</option>
                    <option value="mental_health">üß† Mental Health</option>
                    <option value="goals">üéØ Goals</option>
                    <option value="relationships">‚ù§Ô∏è Relationships</option>
                    <option value="work">üíº Work</option>
                    <option value="health">üèÉ Health</option>
                </select>
            </div>
            
            <div style="margin: 15px 0; padding: 15px; background: #f9fafb; border-radius: 8px; border: 2px solid #e5e7eb;">
                <label style="display: flex; align-items: start; cursor: pointer; margin-bottom: 10px;">
                    <input type="checkbox" id="ageConfirm" style="margin-right: 10px; cursor: pointer;" required>
                    <span style="font-size: 0.9em;"><strong>I confirm I am at least 18 years old</strong> üîû</span>
                </label>
                <label style="display: flex; align-items: start; cursor: pointer;">
                    <input type="checkbox" id="agreeGuidelines" style="margin-right: 10px; cursor: pointer;" required>
                    <span style="font-size: 0.9em;">
                        I have read the <a href="https://github.com/ballales1984-wq/assistente-intelligente-agenda/blob/main/COMMUNITY_GUIDELINES.md" target="_blank" rel="noopener" style="color: #667eea;">community rules</a> 
                        and I am <strong>responsible</strong> for what I post.
                    </span>
                </label>
            </div>
            
            <button onclick="shareReflection()" id="shareBtn" disabled>‚ú® Share with Community</button>
        </div>

        <div class="card">
            <h2>üí¨ Community Feed</h2>
            <div id="feed">Loading...</div>
        </div>
    </div>

    <script>
        // ========================================
        // State
        // ========================================
        let reflections = [];

        // ========================================
        // Load Stats
        // ========================================
        async function loadStats() {
            try {
                const response = await fetch('/api/community/stats');
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('totalReflections').textContent = result.data.total_reflections;
                    document.getElementById('totalComments').textContent = result.data.total_comments;
                    document.getElementById('totalCircles').textContent = result.data.total_circles;
                    document.getElementById('totalReactions').textContent = result.data.total_reactions;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // ========================================
        // Load Feed
        // ========================================
        async function loadFeed() {
            try {
                const response = await fetch('/api/community/reflections?language=en&limit=20');
                const result = await response.json();
                
                if (result.success) {
                    reflections = result.data;
                    renderFeed();
                }
            } catch (error) {
                console.error('Error loading feed:', error);
                document.getElementById('feed').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üòî</div>
                        <p>Error loading feed. Please try again.</p>
                    </div>
                `;
            }
        }

        // ========================================
        // Render Feed
        // ========================================
        function renderFeed() {
            const feedEl = document.getElementById('feed');
            
            if (reflections.length === 0) {
                feedEl.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üå±</div>
                        <p>No reflections yet.</p>
                        <p style="margin-top: 10px;">Be the first to share!</p>
                    </div>
                `;
                return;
            }
            
            feedEl.innerHTML = reflections.map(r => `
                <div class="reflection ${r.sentiment || ''}">
                    <div class="reflection-header">
                        <div>
                            <strong>${r.user.name}</strong> ‚Ä¢ 
                            <span class="reflection-category">${formatCategory(r.category)}</span>
                        </div>
                        <div style="font-size: 0.85em;">
                            ${formatDate(r.created_at)}
                        </div>
                    </div>
                    
                    <div class="reflection-text">
                        ${escapeHtml(r.text)}
                    </div>
                    
                    <div class="reactions">
                        <button class="reaction-btn" onclick="react(${r.id}, 'support')">
                            ‚ù§Ô∏è Support
                        </button>
                        <button class="reaction-btn" onclick="react(${r.id}, 'me_too')">
                            ü§ù Me Too
                        </button>
                        <button class="reaction-btn" onclick="react(${r.id}, 'insightful')">
                            üí° Insightful
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // ========================================
        // Helper Functions
        // ========================================
        function formatCategory(cat) {
            const labels = {
                'personal_growth': 'üå± Growth',
                'mental_health': 'üß† Mental Health',
                'goals': 'üéØ Goals',
                'relationships': '‚ù§Ô∏è Relationships',
                'work': 'üíº Work',
                'health': 'üèÉ Health',
                'creativity': 'üé® Creativity',
                'spirituality': 'üôè Spirituality'
            };
            return labels[cat] || cat;
        }

        function formatDate(isoDate) {
            if (!isoDate) return '';
            const date = new Date(isoDate);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Now';
            if (diffMins < 60) return `${diffMins} min ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function react(reflectionId, reactionType) {
            try {
                const response = await fetch('/api/community/react', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reflection_id: reflectionId,
                        reaction_type: reactionType
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    await loadFeed();
                    // await loadStats(); // TODO: Add stats HTML section
                }
            } catch (error) {
                console.error('Error reacting:', error);
            }
        }

        // ========================================
        // Share Reflection
        // ========================================
        async function shareReflection() {
            const text = document.getElementById('reflectionText').value.trim();
            if (text.length < 20) {
                alert('Reflection must be at least 20 characters.');
                return;
            }
            
            try {
                const response = await fetch('/api/community/reflections', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        visibility: document.getElementById('visibility').value,
                        category: document.getElementById('category').value,
                        language: 'en'
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    document.getElementById('reflectionText').value = '';
                    document.getElementById('ageConfirm').checked = false;
                    document.getElementById('agreeGuidelines').checked = false;
                    checkFormValidity();
                    alert('‚úÖ Reflection shared!');
                    
                    // ‚úÖ RELOAD FEED!
                    await loadFeed();
                    // await loadStats(); // TODO: Add stats HTML section
                    
                    // Scroll to feed
                    document.getElementById('feed').scrollIntoView({ behavior: 'smooth' });
                } else {
                    if (result.crisis_detected) {
                        alert(result.message);
                    } else {
                        alert('Error: ' + (result.error || result.details || 'Unknown'));
                    }
                }
            } catch (error) {
                alert('Error sharing. Please try again.');
            }
        }

        function checkFormValidity() {
            const shareBtn = document.getElementById('shareBtn');
            shareBtn.disabled = !(
                document.getElementById('ageConfirm').checked &&
                document.getElementById('agreeGuidelines').checked &&
                document.getElementById('reflectionText').value.trim().length >= 20
            );
        }

        document.getElementById('ageConfirm').addEventListener('change', checkFormValidity);
        document.getElementById('agreeGuidelines').addEventListener('change', checkFormValidity);
        document.getElementById('reflectionText').addEventListener('input', checkFormValidity);

        // ========================================
        // Initialize on Load
        // ========================================
        window.addEventListener('load', function() {
            // loadStats(); // TODO: Add stats HTML section
            loadFeed();
            checkFormValidity();
        });
    </script>
</body>
</html>

