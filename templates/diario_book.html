<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="ehc2rdX_ZZQV4CI5Ro2pKbgUuM5IbRIR0tTRnVmxjV0" />
    <title>üìñ Il Mio Diario - Assistente Intelligente</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZCZ9CM8HDG"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-ZCZ9CM8HDG');
    </script>
    
    <!-- PageFlip.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-x: hidden;
        }

        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            padding: 12px 25px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            z-index: 100;
            transition: all 0.3s;
        }

        .back-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .book-title {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .book-container {
            position: relative;
            max-width: 900px;
            width: 100%;
        }

        #book {
            margin: 0 auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .page {
            background: #f9f7f1;
            padding: 40px;
            font-family: 'Dancing Script', cursive, Georgia, serif;
            font-size: 1.2em;
            line-height: 1.8;
            color: #333;
            position: relative;
            background-image: 
                linear-gradient(to bottom, transparent 95%, #e8e6df 95%),
                linear-gradient(to right, #f9f7f1 98%, #e8e6df 98%);
            background-size: 100% 30px, 100% 100%;
        }

        .page-date {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 0.9em;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .page-sentiment {
            font-size: 2em;
            margin-bottom: 15px;
        }

        .page-content {
            font-size: 1.1em;
            line-height: 1.9;
            margin-bottom: 20px;
        }

        .page-tags {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 0.8em;
            color: #999;
            margin-top: 20px;
            font-style: italic;
        }

        .page-number {
            position: absolute;
            bottom: 20px;
            right: 40px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 0.9em;
            color: #999;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .control-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 15px 35px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }

        .control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.5em;
            padding: 50px;
        }

        .empty-diary {
            background: white;
            padding: 60px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .empty-diary h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .empty-diary p {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .empty-diary a {
            background: #667eea;
            color: white;
            padding: 15px 40px;
            border-radius: 50px;
            text-decoration: none;
            display: inline-block;
        }

        @media (max-width: 768px) {
            .book-title {
                font-size: 1.8em;
            }
            .page {
                padding: 30px 20px;
                font-size: 1em;
            }
            .control-btn {
                padding: 12px 25px;
                font-size: 1em;
            }
        }

        /* Import Google Font */
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&display=swap');
    </style>
</head>
<body>
    <a href="/" class="back-button">‚Üê Torna all'App</a>
    
    <h1 class="book-title">üìñ Il Mio Diario</h1>

    <div class="loading" id="loading">
        Caricamento del tuo diario... üìö
    </div>

    <div id="emptyState" class="empty-diary" style="display: none;">
        <h2>üìñ Il Tuo Diario √à Vuoto</h2>
        <p>Inizia a scrivere le tue riflessioni giornaliere nella chat!</p>
        <p style="color: #999; font-size: 0.95em;">
            Esempio: <em>"Oggi mi sento motivato e ho imparato molto!"</em>
        </p>
        <a href="/">Vai alla Chat</a>
    </div>

    <div class="book-container" id="bookContainer" style="display: none;">
        <div id="book"></div>
        
        <div class="controls">
            <button class="control-btn" id="prevBtn" onclick="flipPrev()">
                ‚Üê Precedente
            </button>
            <button class="control-btn" id="nextBtn" onclick="flipNext()">
                Successiva ‚Üí
            </button>
        </div>
    </div>

    <script>
        let pageFlip = null;
        let diaryEntries = [];

        // Carica diario dal server
        async function caricaDiario() {
            try {
                const response = await fetch('/api/diario');
                const data = await response.json();
                
                if (data && data.length > 0) {
                    diaryEntries = data.reverse(); // Pi√π recenti prima
                    creaLibro();
                } else {
                    mostraVuoto();
                }
            } catch (error) {
                console.error('Errore caricamento diario:', error);
                mostraVuoto();
            }
        }

        function mostraVuoto() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
        }

        function creaLibro() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('bookContainer').style.display = 'block';

            const bookElement = document.getElementById('book');
            
            // Crea pagine HTML
            let pagesHTML = '';
            
            // Pagina di copertina
            pagesHTML += `
                <div class="page" style="display: flex; flex-direction: column; justify-content: center; align-items: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div style="font-size: 3em; margin-bottom: 20px;">üìñ</div>
                    <div style="font-family: -apple-system, sans-serif; font-size: 2em; font-weight: 800; text-align: center;">
                        Il Mio Diario
                    </div>
                    <div style="font-family: -apple-system, sans-serif; font-size: 1.2em; margin-top: 20px; opacity: 0.9;">
                        ${diaryEntries.length} Riflessioni
                    </div>
                </div>
            `;
            
            // Pagine diario
            diaryEntries.forEach((entry, index) => {
                const sentiment = getSentimentEmoji(entry.sentiment);
                const data = new Date(entry.data).toLocaleDateString('it-IT', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric',
                    weekday: 'long'
                });
                
                pagesHTML += `
                    <div class="page">
                        <div class="page-date">${data}</div>
                        <div class="page-sentiment">${sentiment}</div>
                        <div class="page-content">${entry.testo || entry.contenuto || 'Nessun testo disponibile'}</div>
                        ${entry.parole_chiave ? `<div class="page-tags">üè∑Ô∏è ${entry.parole_chiave}</div>` : ''}
                        <div style="margin-top: 20px; text-align: center;">
                            <button onclick="condividiEntry(${entry.id}, event)" style="background: #667eea; color: white; border: none; padding: 8px 20px; border-radius: 50px; cursor: pointer; font-size: 0.9em; font-weight: 600;">
                                üîó Condividi
                            </button>
                        </div>
                        <div class="page-number">${index + 1}</div>
                    </div>
                `;
            });
            
            // Ultima pagina
            pagesHTML += `
                <div class="page" style="display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <div style="font-size: 2.5em; margin-bottom: 20px;">‚ú®</div>
                    <div style="font-family: -apple-system, sans-serif; font-size: 1.5em; color: #667eea; text-align: center; margin-bottom: 20px;">
                        Fine del Diario
                    </div>
                    <div style="font-family: -apple-system, sans-serif; font-size: 1em; color: #999; text-align: center;">
                        Continua a scrivere le tue riflessioni!
                    </div>
                </div>
            `;
            
            bookElement.innerHTML = pagesHTML;
            
            // Inizializza PageFlip
            const width = Math.min(window.innerWidth - 40, 800);
            const height = Math.min(window.innerHeight - 200, 600);
            
            pageFlip = new St.PageFlip(bookElement, {
                width: width / 2,  // Met√† per ogni pagina
                height: height,
                size: "stretch",
                minWidth: 315,
                maxWidth: 1000,
                minHeight: 400,
                maxHeight: 1350,
                maxShadowOpacity: 0.5,
                showCover: true,
                mobileScrollSupport: true,
                swipeDistance: 30,
                clickEventForward: true,
                useMouseEvents: true
            });
            
            pageFlip.loadFromHTML(document.querySelectorAll('.page'));
            
            // Update buttons
            pageFlip.on('flip', (e) => {
                updateButtons();
            });
            
            updateButtons();
        }

        function getSentimentEmoji(sentiment) {
            const emojiMap = {
                'molto_positivo': 'üòÑ',
                'positivo': 'üòä',
                'neutro': 'üòê',
                'negativo': 'üòî',
                'molto_negativo': 'üò¢'
            };
            return emojiMap[sentiment] || 'üòê';
        }

        function flipNext() {
            if (pageFlip) {
                pageFlip.flipNext();
            }
        }

        function flipPrev() {
            if (pageFlip) {
                pageFlip.flipPrev();
            }
        }

        function updateButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (pageFlip) {
                const currentPage = pageFlip.getCurrentPageIndex();
                const totalPages = pageFlip.getPageCount();
                
                prevBtn.disabled = currentPage <= 0;
                nextBtn.disabled = currentPage >= totalPages - 2;
            }
        }

        // Funzione di condivisione
        async function condividiEntry(entryId, event) {
            event.stopPropagation(); // Previene il flip della pagina
            
            try {
                // Chiama API per generare link di condivisione
                const response = await fetch(`/api/diario/${entryId}/share`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const shareUrl = result.share_url;
                    const shareText = 'üìñ Guarda questa riflessione dal mio Diario!';
                    
                    // Prova Web Share API (mobile)
                    if (navigator.share) {
                        try {
                            await navigator.share({
                                title: 'Riflessione dal Diario',
                                text: shareText,
                                url: shareUrl
                            });
                            alert('‚úÖ Condivisione completata!');
                            return;
                        } catch (err) {
                            if (err.name !== 'AbortError') {
                                console.log('Web Share fallito, uso fallback');
                            }
                        }
                    }
                    
                    // Fallback: mostra opzioni di condivisione
                    const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}`;
                    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareText + ' ' + shareUrl)}`;
                    const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`;
                    
                    const choice = confirm(
                        `üîó Link creato!\n\n` +
                        `Il tuo link di condivisione √® pronto.\n\n` +
                        `Premi OK per copiarlo negli appunti, o ANNULLA per aprire le opzioni social.`
                    );
                    
                    if (choice) {
                        // Copia negli appunti
                        await navigator.clipboard.writeText(shareUrl);
                        alert('‚úÖ Link copiato negli appunti!\n\n' + shareUrl);
                    } else {
                        // Mostra opzioni social
                        const socialChoice = prompt(
                            `Scegli dove condividere:\n\n` +
                            `1 - Twitter\n` +
                            `2 - WhatsApp\n` +
                            `3 - Facebook\n` +
                            `4 - Copia link\n\n` +
                            `Digita il numero:`
                        );
                        
                        switch(socialChoice) {
                            case '1':
                                window.open(twitterUrl, '_blank');
                                break;
                            case '2':
                                window.open(whatsappUrl, '_blank');
                                break;
                            case '3':
                                window.open(facebookUrl, '_blank');
                                break;
                            case '4':
                                await navigator.clipboard.writeText(shareUrl);
                                alert('‚úÖ Link copiato!\n\n' + shareUrl);
                                break;
                            default:
                                // Copia comunque il link
                                await navigator.clipboard.writeText(shareUrl);
                                alert('Link copiato!\n\n' + shareUrl);
                        }
                    }
                } else {
                    alert('‚ùå Errore nella creazione del link di condivisione');
                }
            } catch (error) {
                console.error('Errore condivisione:', error);
                alert('‚ùå Errore durante la condivisione. Riprova.');
            }
        }

        // Carica diario all'avvio
        window.addEventListener('load', caricaDiario);

        // Responsive: ricrea libro quando ridimensioni
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                if (diaryEntries.length > 0) {
                    creaLibro();
                }
            }, 300);
        });
    </script>
</head>
<body>
    <!-- Content dinamico caricato da JavaScript -->
</body>
</html>

